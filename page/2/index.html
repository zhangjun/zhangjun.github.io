<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="风花雪月">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="风花雪月">
<meta property="og:locale">
<meta property="article:author" content="zhangjun">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>风花雪月</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">风花雪月</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/content/2021/12/09/article/docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhangjun">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风花雪月">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/content/2021/12/09/article/docker/" class="post-title-link" itemprop="url">docker</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-12-09 06:33:23" itemprop="dateCreated datePublished" datetime="2021-12-09T06:33:23+00:00">2021-12-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-03 15:49:50" itemprop="dateModified" datetime="2023-10-03T15:49:50+00:00">2023-10-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="docker-build"><a href="#docker-build" class="headerlink" title="docker build"></a>docker build</h1><p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/">https://docs.docker.com/engine/reference/builder/</a></p>
<h2 id="install-docker"><a href="#install-docker" class="headerlink" title="install docker"></a>install docker</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y yum-utils</span><br><span class="line">sudo yum-config-manager --add-repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;docker-ce&#x2F;linux&#x2F;centos&#x2F;docker-ce.repo</span><br></pre></td></tr></table></figure>
<h1 id="ubuntu-docker"><a href="#ubuntu-docker" class="headerlink" title="ubuntu docker"></a>ubuntu docker</h1><p> <a target="_blank" rel="noopener" href="https://askubuntu.com/questions/1140183/install-gcc-9-on-ubuntu-18-04">https://askubuntu.com/questions/1140183/install-gcc-9-on-ubuntu-18-04</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:16.04</span><br><span class="line"></span><br><span class="line">LABEL com.zhangjun.image.authors&#x3D;&quot;ewalker.zj@gmail.com&quot;</span><br><span class="line"></span><br><span class="line">ENV TZ &quot;Asia&#x2F;Shanghai&quot;</span><br><span class="line"></span><br><span class="line">RUN apt update &amp;&amp; \</span><br><span class="line">    apt -qqy install software-properties-common &amp;&amp; \</span><br><span class="line">    add-apt-repository -y  ppa:ubuntu-toolchain-r&#x2F;test &amp;&amp; \</span><br><span class="line">    add-apt-repository -y ppa:deadsnakes&#x2F;ppa &amp;&amp; \</span><br><span class="line">    apt update &amp;&amp; \</span><br><span class="line">    apt -qqy install gcc-9 g++-9 &amp;&amp; \</span><br><span class="line">    apt -qqy install python3.7 &amp;&amp; \</span><br><span class="line">    update-alternatives --install &#x2F;usr&#x2F;bin&#x2F;python python &#x2F;usr&#x2F;bin&#x2F;python3.7 10 &amp;&amp; \</span><br><span class="line">    update-alternatives --install &#x2F;usr&#x2F;bin&#x2F;gcc gcc &#x2F;usr&#x2F;bin&#x2F;gcc-9 40 --slave &#x2F;usr&#x2F;bin&#x2F;g++ g++ &#x2F;usr&#x2F;bin&#x2F;g++-9 &amp;&amp; \</span><br><span class="line">    wget https:&#x2F;&#x2F;bootstrap.pypa.io&#x2F;get-pip.py &amp;&amp; \</span><br><span class="line">    python3.7 get-pip.py &amp;&amp; \</span><br><span class="line">    python3.7 -m pip install pre-commit &amp;&amp; \</span><br><span class="line">    apt-get -qqy clean &amp;&amp; \</span><br><span class="line">    rm -rf get-pip.py &amp;&amp; rm -rf &#x2F;var&#x2F;lib&#x2F;apt&#x2F;lists&#x2F;*</span><br><span class="line"></span><br><span class="line">#    update-alternatives --config gcc</span><br><span class="line">#    update-alternatives --config python</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/content/2021/12/09/article/use-macos/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhangjun">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风花雪月">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/content/2021/12/09/article/use-macos/" class="post-title-link" itemprop="url">macOS tips</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-12-09 06:31:52" itemprop="dateCreated datePublished" datetime="2021-12-09T06:31:52+00:00">2021-12-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-03 15:49:50" itemprop="dateModified" datetime="2023-10-03T15:49:50+00:00">2023-10-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="macOS-python-load-Framework"><a href="#macOS-python-load-Framework" class="headerlink" title="macOS python load Framework"></a>macOS python load Framework</h1><p><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/ctypes.html">https://docs.python.org/3/library/ctypes.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from ctypes.util import find_library</span><br><span class="line">from ctypes import cdll</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">print(os.name)</span><br><span class="line">metal_library &#x3D; find_library(&quot;Metal&quot;)</span><br><span class="line">core_graphics_library &#x3D; find_library(&quot;CoreGraphics&quot;)</span><br><span class="line">mps_library &#x3D; find_library(&quot;MetalPerformanceShaders&quot;)</span><br><span class="line"></span><br><span class="line">print(cdll.LoadLibrary(metal_library))</span><br><span class="line">print(cdll.LoadLibrary(core_graphics_library))</span><br><span class="line">print(cdll.LoadLibrary(mps_library))</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/content/2021/09/19/article/paddle-lite/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhangjun">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风花雪月">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/content/2021/09/19/article/paddle-lite/" class="post-title-link" itemprop="url">Paddle Lite framework</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-19 14:13:58" itemprop="dateCreated datePublished" datetime="2021-09-19T14:13:58+00:00">2021-09-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-03 15:49:50" itemprop="dateModified" datetime="2023-10-03T15:49:50+00:00">2023-10-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="core"><a href="#core" class="headerlink" title="core"></a>core</h1><h2 id="context"><a href="#context" class="headerlink" title="context"></a>context</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">class KernelContext &#123;</span><br><span class="line"> public:</span><br><span class="line">  template &lt;typename ContextT&gt;</span><br><span class="line">  ContextT&amp; As() &#123;</span><br><span class="line">    if (!ctx_.valid()) &#123;</span><br><span class="line">      ctx_.set&lt;ContextT&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    return *ctx_.get_mutable&lt;ContextT&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> private:</span><br><span class="line">  Any ctx_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">class ContextScheduler &#123;</span><br><span class="line"> public:</span><br><span class="line">  static ContextScheduler&amp; Global() &#123;</span><br><span class="line">    static auto* x &#x3D; new ContextScheduler;</span><br><span class="line">    return *x;</span><br><span class="line">  &#125;</span><br><span class="line">  std::unique_ptr&lt;KernelContext&gt; NewContext(</span><br><span class="line">      TargetType target,</span><br><span class="line">      &#x2F;*only used for cuda context*&#x2F; int exec_stream_id &#x3D; 0) &#123;</span><br><span class="line">    std::unique_ptr&lt;KernelContext&gt; ctx(new KernelContext);</span><br><span class="line">    switch (target) &#123;</span><br><span class="line">      case TARGET(kHost):</span><br><span class="line">        kernel_contexts_[TargetType::kHost].As&lt;HostContext&gt;().CopySharedTo(</span><br><span class="line">            &amp;ctx-&gt;As&lt;HostContext&gt;());</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">    return ctx;</span><br><span class="line">  &#125; </span><br><span class="line">private:</span><br><span class="line">  template &lt;TargetType Type, typename ContextT&gt;</span><br><span class="line">  void InitContext() &#123;</span><br><span class="line">    kernel_contexts_[Type].As&lt;ContextT&gt;().InitOnce();</span><br><span class="line">  &#125;</span><br><span class="line">  ContextScheduler() &#123;</span><br><span class="line">    InitContext&lt;TargetType::kHost, HostContext&gt;();</span><br><span class="line">  &#125;</span><br><span class="line">private:</span><br><span class="line">  std::map&lt;TargetType, KernelContext&gt; kernel_contexts_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="op-lite"><a href="#op-lite" class="headerlink" title="op lite"></a>op lite</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">class OpLite : public Registry &#123;</span><br><span class="line"> public:</span><br><span class="line">  OpLite() &#x3D; default;</span><br><span class="line">  explicit OpLite(const std::string &amp;type) : op_type_(type) &#123;&#125;</span><br><span class="line">  explicit OpLite(const std::vector&lt;Place&gt; &amp;valid_places)</span><br><span class="line">      : valid_places_(valid_places) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  void SetValidPlaces(const std::vector&lt;Place&gt; &amp;places) &#123;</span><br><span class="line">    VLOG(5) &lt;&lt; &quot;valid places &quot; &lt;&lt; valid_places_.size();</span><br><span class="line">    valid_places_ &#x3D; places;</span><br><span class="line">  &#125;</span><br><span class="line">  virtual bool Run();</span><br><span class="line">  &#x2F;&#x2F; Indicate whether the Op runs only once or not</span><br><span class="line">  virtual bool run_once() const &#123; return false; &#125;</span><br><span class="line">  std::string Type() const &#123; return op_type_; &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Link the external execution environ to internal context.</span><br><span class="line">  bool Attach(const cpp::OpDesc &amp;opdesc, lite::Scope *scope);</span><br><span class="line"></span><br><span class="line">  template &lt;typename T&gt;</span><br><span class="line">  inline void AttachParam(T *param) &#123;</span><br><span class="line">    op_param_ &#x3D; static_cast&lt;T *&gt;(param);</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; Create all the kernels for the valid targets.</span><br><span class="line">  std::vector&lt;std::unique_ptr&lt;KernelBase&gt;&gt; CreateKernels(</span><br><span class="line">      const std::vector&lt;Place&gt; &amp;places, const std::string &amp;kernel_type &#x3D; &quot;&quot;);</span><br><span class="line"></span><br><span class="line">  Scope *scope() &#123; return scope_; &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Assign op param to kernel.</span><br><span class="line">  virtual void AttachKernel(KernelBase *kernel) &#x3D; 0;</span><br><span class="line">  void SetKernel(std::vector&lt;std::unique_ptr&lt;KernelBase&gt;&gt; &amp;kernels) &#123;  &#x2F;&#x2F; NOLINT</span><br><span class="line">    kernel_ &#x3D; std::move(kernels.front());</span><br><span class="line">    kernel_-&gt;SetContext(</span><br><span class="line">        ContextScheduler::Global().NewContext(kernel_-&gt;target()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  KernelBase *GetKernel() &#123;  &#x2F;&#x2F; NOLINT</span><br><span class="line">    return kernel_.get();</span><br><span class="line">  &#125;</span><br><span class="line">  virtual ~OpLite() &#x3D; default;</span><br><span class="line"> protected:</span><br><span class="line">  friend class mir::Node;</span><br><span class="line">  friend class mir::SSAGraph;</span><br><span class="line"> protected:</span><br><span class="line">  Scope *scope_&#123;nullptr&#125;;</span><br><span class="line">  std::unique_ptr&lt;KernelBase&gt; kernel_;</span><br><span class="line">  std::string op_type_;</span><br><span class="line">  std::vector&lt;Place&gt; valid_places_;</span><br><span class="line">  Place kernel_place_&#123;TARGET(kHost), PRECISION(kFloat)&#125;;</span><br><span class="line">  std::unique_ptr&lt;OpInfo&gt; op_info_;</span><br><span class="line">  &#x2F;&#x2F; todo: it&#39;s prefered to combine last_input_shapes and</span><br><span class="line">  &#x2F;&#x2F; last_input_lods into a single hash value to decrease</span><br><span class="line">  &#x2F;&#x2F; memory usage.</span><br><span class="line">  std::vector&lt;DDimLite&gt; last_input_shapes&#123;&#125;;</span><br><span class="line">  std::vector&lt;std::vector&lt;std::vector&lt;uint64_t&gt;&gt;&gt; last_input_lods&#123;&#125;;</span><br><span class="line">  std::vector&lt;DDimLite&gt; last_output_shapes&#123;&#125;;</span><br><span class="line">  std::vector&lt;std::vector&lt;std::vector&lt;uint64_t&gt;&gt;&gt; last_output_lods&#123;&#125;;</span><br><span class="line">  mutable operators::ParamBase *op_param_&#123;nullptr&#125;;</span><br><span class="line"></span><br><span class="line"> private:</span><br><span class="line">  &#x2F;&#x2F; Infer Shape according to memory, if current input shapes are consistent</span><br><span class="line">  &#x2F;&#x2F; with that of previous inputs, output shapes of last time will be reused.</span><br><span class="line">  bool InferShapeWithCache();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;std::unique_ptr&lt;KernelBase&gt;&gt; OpLite::CreateKernels(</span><br><span class="line">    const std::vector&lt;Place&gt; &amp;places, const std::string &amp;kernel_type) &#123;</span><br><span class="line">  std::vector&lt;std::unique_ptr&lt;KernelBase&gt;&gt; kernels;</span><br><span class="line">  CHECK(!op_type_.empty()) &lt;&lt; &quot;op_type_ should be set first&quot;;</span><br><span class="line"></span><br><span class="line">  auto pick_kernel &#x3D; [&amp;](const Place &amp;place) &#123;</span><br><span class="line">    auto ks &#x3D; KernelRegistry::Global().Create(</span><br><span class="line">        op_type_, place.target, place.precision, place.layout);</span><br><span class="line">    VLOG(5) &lt;&lt; &quot;pick kernel for &quot; &lt;&lt; op_info()-&gt;Type() &lt;&lt; &quot; &quot;</span><br><span class="line">            &lt;&lt; place.DebugString() &lt;&lt; &quot; get &quot; &lt;&lt; ks.size() &lt;&lt; &quot; kernels&quot;;</span><br><span class="line">    for (auto &amp;&amp;it : ks) &#123;</span><br><span class="line">      AttachKernel(it.get());</span><br><span class="line">      kernels.emplace_back(std::move(it));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  if (!kernel_type.empty()) &#123;</span><br><span class="line">    Place place;</span><br><span class="line">    std::string op_type, alias;</span><br><span class="line">    KernelBase::ParseKernelType(kernel_type, &amp;op_type, &amp;alias, &amp;place);</span><br><span class="line">    pick_kernel(place);</span><br><span class="line">    CHECK(!kernels.empty()) &lt;&lt; &quot;no kernel for kernel type &quot; &lt;&lt; kernel_type;</span><br><span class="line">    return kernels;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::set&lt;Place&gt; expanded_places(places.begin(), places.end());</span><br><span class="line">  for (auto &amp;place : places) &#123;</span><br><span class="line">    &#x2F;&#x2F; Pick kernels those support any Precision and any DataLayout, For example:</span><br><span class="line">    &#x2F;&#x2F; kARM,kFloat,kNCHW -&gt; kARM,kFloat,kAny; kARM,kAny,kNCHW; kARM,kAny,kAny</span><br><span class="line">    expanded_places.insert(</span><br><span class="line">        Place(place.target, place.precision, DATALAYOUT(kAny)));</span><br><span class="line">    expanded_places.insert(Place(place.target, PRECISION(kAny), place.layout));</span><br><span class="line">    expanded_places.insert(</span><br><span class="line">        Place(place.target, PRECISION(kAny), DATALAYOUT(kAny)));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::set&lt;TargetType&gt; targets;</span><br><span class="line">  for (auto place : expanded_places) &#123;</span><br><span class="line">    pick_kernel(place);</span><br><span class="line">    targets.insert(place.target);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  VLOG(5) &lt;&lt; &quot;op &quot; &lt;&lt; op_type_ &lt;&lt; &quot; get &quot; &lt;&lt; kernels.size() &lt;&lt; &quot; kernels&quot;;</span><br><span class="line">  return kernels;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Operator Information, such as some description. It will be shared by all the</span><br><span class="line"> * kernels of the same operator.</span><br><span class="line"> *&#x2F;</span><br><span class="line">class OpInfo : public cpp::OpDesc &#123;</span><br><span class="line"> public:</span><br><span class="line">  OpInfo(const OpInfo &amp;) &#x3D; default;</span><br><span class="line">  explicit OpInfo(const cpp::OpDesc &amp;other) : cpp::OpDesc(other) &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="op-registry"><a href="#op-registry" class="headerlink" title="op registry"></a>op registry</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class OpKernelInfoCollector &#123;</span><br><span class="line"> public:</span><br><span class="line">  static OpKernelInfoCollector&amp; Global() &#123;</span><br><span class="line">    static auto* x &#x3D; new OpKernelInfoCollector;</span><br><span class="line">    return *x;</span><br><span class="line">  &#125;</span><br><span class="line">  void AddOp2path(const std::string&amp; op_name, const std::string&amp; op_path);</span><br><span class="line">  void AddKernel2path(const std::string&amp; kernel_name,</span><br><span class="line">                      const std::string&amp; kernel_path);</span><br><span class="line">  </span><br><span class="line"> private:</span><br><span class="line">  std::map&lt;std::string, std::string&gt; op2path_;</span><br><span class="line">  std::map&lt;std::string, std::string&gt; kernel2path_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">class OpLiteFactory &#123;</span><br><span class="line"> public:</span><br><span class="line">  &#x2F;&#x2F; Register a function to create an op</span><br><span class="line">  void RegisterCreator(const std::string&amp; op_type,</span><br><span class="line">                       std::function&lt;std::shared_ptr&lt;OpLite&gt;()&gt; fun) &#123;</span><br><span class="line">    op_registry_[op_type] &#x3D; fun;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  static OpLiteFactory&amp; Global() &#123;</span><br><span class="line">    static OpLiteFactory* x &#x3D; new OpLiteFactory;</span><br><span class="line">    return *x;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::shared_ptr&lt;OpLite&gt; Create(const std::string&amp; op_type) const &#123;</span><br><span class="line">    auto it &#x3D; op_registry_.find(op_type);</span><br><span class="line">    if (it &#x3D;&#x3D; op_registry_.end()) return nullptr;</span><br><span class="line">    return it-&gt;second();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::string DebugString();</span><br><span class="line"></span><br><span class="line">  std::vector&lt;std::string&gt; GetAllOps() const &#123;</span><br><span class="line">    std::vector&lt;std::string&gt; res;</span><br><span class="line">    for (const auto&amp; op : op_registry_) &#123;</span><br><span class="line">      res.push_back(op.first);</span><br><span class="line">    &#125;</span><br><span class="line">    return res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> protected:</span><br><span class="line">  std::map&lt;std::string, std::function&lt;std::shared_ptr&lt;OpLite&gt;()&gt;&gt; op_registry_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">class OpLiteRegistrar &#123;</span><br><span class="line"> public:</span><br><span class="line">  OpLiteRegistrar(const std::string&amp; op_type,</span><br><span class="line">                  std::function&lt;std::shared_ptr&lt;OpLite&gt;()&gt; fun) &#123;</span><br><span class="line">    OpLiteFactory::Global().RegisterCreator(op_type, fun);</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; Touch function is used to guarantee registrar was initialized.</span><br><span class="line">  void touch() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class KernelFactory &#123;</span><br><span class="line"> public:</span><br><span class="line">  &#x2F;&#x2F; Register a function to create kernels</span><br><span class="line">  void RegisterCreator(const std::string&amp; op_type,</span><br><span class="line">                       TargetType target,</span><br><span class="line">                       PrecisionType precision,</span><br><span class="line">                       DataLayoutType layout,</span><br><span class="line">                       std::function&lt;std::unique_ptr&lt;KernelBase&gt;()&gt; fun) &#123;</span><br><span class="line">    op_registry_[op_type][std::make_tuple(target, precision, layout)].push_back(</span><br><span class="line">        fun);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  static KernelFactory&amp; Global() &#123;</span><br><span class="line">    static KernelFactory* x &#x3D; new KernelFactory;</span><br><span class="line">    return *x;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * Create all kernels belongs to an op.</span><br><span class="line">   *&#x2F;</span><br><span class="line">  std::list&lt;std::unique_ptr&lt;KernelBase&gt;&gt; Create(const std::string&amp; op_type) &#123;</span><br><span class="line">    std::list&lt;std::unique_ptr&lt;KernelBase&gt;&gt; res;</span><br><span class="line">    if (op_registry_.find(op_type) &#x3D;&#x3D; op_registry_.end()) return res;</span><br><span class="line">    auto&amp; kernel_registry &#x3D; op_registry_[op_type];</span><br><span class="line">    for (auto it &#x3D; kernel_registry.begin(); it !&#x3D; kernel_registry.end(); ++it) &#123;</span><br><span class="line">      for (auto&amp; fun : it-&gt;second) &#123;</span><br><span class="line">        res.emplace_back(fun());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * Create a specific kernel. Return a list for API compatible.</span><br><span class="line">   *&#x2F;</span><br><span class="line">  std::list&lt;std::unique_ptr&lt;KernelBase&gt;&gt; Create(const std::string&amp; op_type,</span><br><span class="line">                                                TargetType target,</span><br><span class="line">                                                PrecisionType precision,</span><br><span class="line">                                                DataLayoutType layout) &#123;</span><br><span class="line">    std::list&lt;std::unique_ptr&lt;KernelBase&gt;&gt; res;</span><br><span class="line">    if (op_registry_.find(op_type) &#x3D;&#x3D; op_registry_.end()) return res;</span><br><span class="line">    auto&amp; kernel_registry &#x3D; op_registry_[op_type];</span><br><span class="line">    auto it &#x3D; kernel_registry.find(std::make_tuple(target, precision, layout));</span><br><span class="line">    if (it &#x3D;&#x3D; kernel_registry.end()) return res;</span><br><span class="line">    for (auto&amp; fun : it-&gt;second) &#123;</span><br><span class="line">      res.emplace_back(fun());</span><br><span class="line">    &#125;</span><br><span class="line">    return res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> protected:</span><br><span class="line">  &#x2F;&#x2F; Outer map: op -&gt; a map of kernel.</span><br><span class="line">  &#x2F;&#x2F; Inner map: kernel -&gt; creator function.</span><br><span class="line">  &#x2F;&#x2F; Each kernel was represented by a combination of &lt;TargetType, PrecisionType,</span><br><span class="line">  &#x2F;&#x2F; DataLayoutType&gt;</span><br><span class="line">  std::map&lt;std::string,</span><br><span class="line">           std::map&lt;std::tuple&lt;TargetType, PrecisionType, DataLayoutType&gt;,</span><br><span class="line">                    std::list&lt;std::function&lt;std::unique_ptr&lt;KernelBase&gt;()&gt;&gt;&gt;&gt;</span><br><span class="line">      op_registry_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Register Kernel by initializing a static KernelRegistrar instance</span><br><span class="line">class KernelRegistrar &#123;</span><br><span class="line"> public:</span><br><span class="line">  KernelRegistrar(const std::string&amp; op_type,</span><br><span class="line">                  TargetType target,</span><br><span class="line">                  PrecisionType precision,</span><br><span class="line">                  DataLayoutType layout,</span><br><span class="line">                  std::function&lt;std::unique_ptr&lt;KernelBase&gt;()&gt; fun) &#123;</span><br><span class="line">    KernelFactory::Global().RegisterCreator(</span><br><span class="line">        op_type, target, precision, layout, fun);</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; Touch function is used to guarantee registrar was initialized.</span><br><span class="line">  void touch() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class ParamTypeDummyRegistry &#123;</span><br><span class="line"> public:</span><br><span class="line">  struct NewInstance &#123;</span><br><span class="line">    NewInstance() &#123;&#125;</span><br><span class="line">    NewInstance&amp; BindInput(const std::string&amp; arg_name,</span><br><span class="line">                           const ParamType&amp; ptype) &#123;</span><br><span class="line">      return *this;</span><br><span class="line">    &#125;</span><br><span class="line">    NewInstance&amp; BindOutput(const std::string&amp; arg_name,</span><br><span class="line">                            const ParamType&amp; ptype) &#123;</span><br><span class="line">      return *this;</span><br><span class="line">    &#125;</span><br><span class="line">    NewInstance&amp; SetVersion(const std::string&amp; version) &#123; return *this; &#125;</span><br><span class="line">    NewInstance&amp; BindPaddleOpVersion(const std::string&amp; op_type,</span><br><span class="line">                                     int32_t version_id) &#123;</span><br><span class="line">      return *this;</span><br><span class="line">    &#125;</span><br><span class="line">    bool Finalize() &#123; return true; &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"> private:</span><br><span class="line">  ParamTypeDummyRegistry() &#x3D; default;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="注册机制"><a href="#注册机制" class="headerlink" title="注册机制"></a>注册机制</h1><h2 id="op注册"><a href="#op注册" class="headerlink" title="op注册"></a>op注册</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#define REGISTER_LITE_OP(op_type__, OpClass)                                   \</span><br><span class="line">  static paddle::lite::OpLiteRegistrar op_type__##__registry(                  \</span><br><span class="line">      #op_type__, []() &#123;                                                       \</span><br><span class="line">        return std::unique_ptr&lt;paddle::lite::OpLite&gt;(new OpClass(#op_type__)); \</span><br><span class="line">      &#125;);                                                                      \</span><br><span class="line">  int touch_op_##op_type__() &#123;                                                 \</span><br><span class="line">    op_type__##__registry.touch();                                             \</span><br><span class="line">    OpKernelInfoCollector::Global().AddOp2path(#op_type__, __FILE__);          \</span><br><span class="line">    return 0;                                                                  \</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="kernel-注册"><a href="#kernel-注册" class="headerlink" title="kernel 注册"></a>kernel 注册</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Register a kernel.</span><br><span class="line">#define REGISTER_LITE_KERNEL(                                                 \</span><br><span class="line">    op_type__, target__, precision__, layout__, KernelClass, alias__)         \</span><br><span class="line">  static paddle::lite::KernelRegistrar                                        \</span><br><span class="line">      op_type__##target__##precision__##layout__##alias__##_kernel_registry(  \</span><br><span class="line">          #op_type__,                                                         \</span><br><span class="line">          TARGET(target__),                                                   \</span><br><span class="line">          PRECISION(precision__),                                             \</span><br><span class="line">          DATALAYOUT(layout__),                                               \</span><br><span class="line">          []() &#123;                                                              \</span><br><span class="line">            std::unique_ptr&lt;KernelClass&gt; x(new KernelClass);                  \</span><br><span class="line">            x-&gt;set_op_type(#op_type__);                                       \</span><br><span class="line">            x-&gt;set_alias(#alias__);                                           \</span><br><span class="line">            return x;                                                         \</span><br><span class="line">          &#125;);                                                                 \</span><br><span class="line">  int touch_##op_type__##target__##precision__##layout__##alias__() &#123;         \</span><br><span class="line">    op_type__##target__##precision__##layout__##alias__##_kernel_registry     \</span><br><span class="line">        .touch();                                                             \</span><br><span class="line">    OpKernelInfoCollector::Global().AddKernel2path(                           \</span><br><span class="line">        #op_type__ &quot;,&quot; #target__ &quot;,&quot; #precision__ &quot;,&quot; #layout__ &quot;,&quot; #alias__, \</span><br><span class="line">        __FILE__);                                                            \</span><br><span class="line">    return 0;                                                                 \</span><br><span class="line">  &#125;                                                                           \</span><br><span class="line">  ParamTypeRegistry(                                                          \</span><br><span class="line">      op_type__, target__, precision__, layout__, KernelClass, alias__)</span><br></pre></td></tr></table></figure>
<h1 id="program"><a href="#program" class="headerlink" title="program"></a>program</h1><h2 id="scope"><a href="#scope" class="headerlink" title="scope"></a>scope</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">class Scope final &#123;</span><br><span class="line"> public:</span><br><span class="line">  Scope()</span><br><span class="line">      : kids_lock_&#123;new lite::fluid::RWLock&#125;,</span><br><span class="line">        vars_lock_&#123;new lite::fluid::RWLock&#125;,</span><br><span class="line">        rwlock_&#123;new lite::fluid::RWLock&#125; &#123;&#125;</span><br><span class="line">  &#x2F;&#x2F; delete below two functions to allow pybind to recognise it cannot make a</span><br><span class="line">  &#x2F;&#x2F; copy</span><br><span class="line">  &#x2F;&#x2F; link:</span><br><span class="line">  &#x2F;&#x2F; https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;53807248&#x2F;pybind11-returning-a-pointer-to-a-container-of-unique-ptr</span><br><span class="line">  Scope(const Scope&amp;) &#x3D; delete;</span><br><span class="line">  Scope&amp; operator&#x3D;(const Scope&amp;) &#x3D; delete;</span><br><span class="line">  ~Scope();</span><br><span class="line"></span><br><span class="line">  Scope&amp; NewScope() const;</span><br><span class="line"></span><br><span class="line">  Variable* Var(const std::string&amp; name);</span><br><span class="line"></span><br><span class="line">  Variable* LocalVar(const std::string&amp; name);</span><br><span class="line"></span><br><span class="line">  Variable* FindVar(const std::string&amp; name) const;</span><br><span class="line"></span><br><span class="line">  Variable* FindLocalVar(const std::string&amp; name) const;</span><br><span class="line"></span><br><span class="line">  const Scope* parent() const &#123; return parent_; &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Get attribute params stored in parent scopes.</span><br><span class="line">  std::vector&lt;std::string&gt; AttributeVarNames() const;</span><br><span class="line">  &#x2F;&#x2F; Following the legacy scope interface.</span><br><span class="line">  std::vector&lt;std::string&gt; LocalVarNames() const;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F;&#x2F; ------------------------------------- helper functions for Tensor</span><br><span class="line">  &#x2F;&#x2F;&#x2F; ----------------------------------</span><br><span class="line">  &#x2F;&#x2F; Create a Tensor variable. This will create a new Variable called &#96;name&#96;.</span><br><span class="line">  Tensor* NewTensor(const std::string&amp; name) &#123;</span><br><span class="line">    auto* var &#x3D; Var(name);</span><br><span class="line">    return var-&gt;GetMutable&lt;Tensor&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const Tensor* FindTensor(const std::string&amp; name) &#123;</span><br><span class="line">    auto* var &#x3D; FindVar(name);</span><br><span class="line">    if (!var) return nullptr;</span><br><span class="line">    return &amp;var-&gt;Get&lt;Tensor&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Tensor* FindMutableTensor(const std::string&amp; name) &#123;</span><br><span class="line">    auto* var &#x3D; FindVar(name);</span><br><span class="line">    if (!var) return nullptr;</span><br><span class="line">    return var-&gt;GetMutable&lt;Tensor&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::vector&lt;Tensor&gt;* NewTensorList(const std::string&amp; name) &#123;</span><br><span class="line">    auto* var &#x3D; Var(name);</span><br><span class="line">    return var-&gt;GetMutable&lt;std::vector&lt;Tensor&gt;&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const std::vector&lt;Tensor&gt;* FindTensorList(const std::string&amp; name) &#123;</span><br><span class="line">    auto* var &#x3D; FindVar(name);</span><br><span class="line">    if (!var) return nullptr;</span><br><span class="line">    return &amp;var-&gt;Get&lt;std::vector&lt;Tensor&gt;&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::vector&lt;Tensor&gt;* FindMutableTensorList(const std::string&amp; name) &#123;</span><br><span class="line">    auto* var &#x3D; FindVar(name);</span><br><span class="line">    if (!var) return nullptr;</span><br><span class="line">    return var-&gt;GetMutable&lt;std::vector&lt;Tensor&gt;&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> private:</span><br><span class="line">  &#x2F;&#x2F; Scope in &#96;kids_&#96; are owned by this class.</span><br><span class="line">  mutable std::list&lt;Scope*&gt; kids_;</span><br><span class="line">  const Scope* parent_&#123;nullptr&#125;;</span><br><span class="line">  std::map&lt;std::string, std::unique_ptr&lt;Variable&gt;&gt; vars_;</span><br><span class="line">  std::unique_ptr&lt;lite::fluid::RWLock&gt; kids_lock_&#123;nullptr&#125;;</span><br><span class="line">  std::unique_ptr&lt;lite::fluid::RWLock&gt; vars_lock_&#123;nullptr&#125;;</span><br><span class="line">  std::unique_ptr&lt;lite::fluid::RWLock&gt; rwlock_&#123;nullptr&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="optimize"><a href="#optimize" class="headerlink" title="optimize"></a>optimize</h1><h2 id="optimizer"><a href="#optimizer" class="headerlink" title="optimizer"></a>optimizer</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * lite::Optimizer optimize a program. It utilize the mir passes to analysis the</span><br><span class="line"> * program and export an optimized program.</span><br><span class="line"> * Example :</span><br><span class="line"> *       &#x2F;&#x2F; (1) Create an optimizer</span><br><span class="line"> *       Optimizer optim(valid_places, kernel_pick_factor);</span><br><span class="line"> *       &#x2F;&#x2F; (2) add an optimizer method</span><br><span class="line"> *       optim.AddPass(&quot;post_quant_dynamic_pass&quot;);</span><br><span class="line"> *       &#x2F;&#x2F; (3) analysis a program to export an optimized program</span><br><span class="line"> *       auto program_ &#x3D; optim.Run(std::move(program));</span><br><span class="line"> *&#x2F;</span><br><span class="line">class Optimizer &#123;</span><br><span class="line"> public:</span><br><span class="line">  Optimizer(const std::vector&lt;Place&gt;&amp; valid_places,</span><br><span class="line">            core::KernelPickFactor kernel_pick_factor)</span><br><span class="line">      : valid_places_(valid_places), kernel_pick_factor_(kernel_pick_factor) &#123;</span><br><span class="line">    CHECK(!valid_places.empty()) &lt;&lt; &quot;At least one valid_place should be set&quot;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Append a pass to the optimizer.</span><br><span class="line">  void AddPass(const std::string&amp; pass_name);</span><br><span class="line">  &#x2F;&#x2F; Optimize a program to generate a runtime program.</span><br><span class="line">  std::unique_ptr&lt;RuntimeProgram&gt; Run(Program&amp;&amp; program);</span><br><span class="line"></span><br><span class="line"> protected:</span><br><span class="line">  &#x2F;&#x2F; Run all the added passes.</span><br><span class="line">  void ApplyPasses(std::vector&lt;std::unique_ptr&lt;mir::SSAGraph&gt;&gt;* graphes);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Generate the optimized runtime program.</span><br><span class="line">  std::unique_ptr&lt;RuntimeProgram&gt; GenRuntimeProgram(</span><br><span class="line">      std::vector&lt;std::unique_ptr&lt;mir::SSAGraph&gt;&gt;* graphs);</span><br><span class="line"></span><br><span class="line">  void InitTargetTypeTransformPass();</span><br><span class="line">  void InitControlFlowOpUnusedInputsAndOutputsEliminatePass();</span><br><span class="line">  void InitControlFlowOpSharedInputsAndOutputsPlaceSyncPass();</span><br><span class="line">  void SpecifyKernelPickTactic(core::KernelPickFactor factor);</span><br><span class="line">  Scope* exec_scope() &#123; return exec_scope_; &#125;</span><br><span class="line"></span><br><span class="line"> private:</span><br><span class="line">  std::vector&lt;Place&gt; valid_places_;</span><br><span class="line">  Scope* exec_scope_&#123;&#125;;</span><br><span class="line">  std::vector&lt;mir::Pass*&gt; passes_;</span><br><span class="line">  std::vector&lt;std::unique_ptr&lt;mir::SSAGraph&gt;&gt; graphs_;</span><br><span class="line">  core::KernelPickFactor kernel_pick_factor_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/content/2021/09/05/article/metal_basic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhangjun">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风花雪月">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/content/2021/09/05/article/metal_basic/" class="post-title-link" itemprop="url">Metal Basic</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-05 10:01:57" itemprop="dateCreated datePublished" datetime="2021-09-05T10:01:57+00:00">2021-09-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-03 15:49:50" itemprop="dateModified" datetime="2023-10-03T15:49:50+00:00">2023-10-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="metal-buffer-anc-texture"><a href="#metal-buffer-anc-texture" class="headerlink" title="metal buffer anc texture"></a>metal buffer anc texture</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">id&lt;MTLDevice&gt; device &#x3D; MTLCreateSystemDefaultDevice();</span><br><span class="line"></span><br><span class="line">MTLTextureDescriptor* desc &#x3D; [[MTLTextureDescriptor alloc] init];</span><br><span class="line">[desc setTextureType:MTLTextureType2DArray];</span><br><span class="line">[desc setDepth:1];</span><br><span class="line">desc.width &#x3D; static_cast&lt;NSUInteger&gt;(dim[2]);</span><br><span class="line">desc.height &#x3D; static_cast&lt;NSUInteger&gt;(dim[1]);</span><br><span class="line">desc.arrayLength &#x3D; static_cast&lt;NSUInteger&gt;(((dim[0]) * (dim[3]) + 3) &#x2F; 4);</span><br><span class="line">desc.pixelFormat &#x3D; MTLPixelFormatRGBA16Float;</span><br><span class="line">desc.usage &#x3D; MTLTextureUsageShaderRead | MTLTextureUsageShaderWrite;</span><br><span class="line">desc.storageMode &#x3D; MTLStorageModeShared;</span><br><span class="line"></span><br><span class="line">id&lt;MTLTexture&gt; image_ &#x3D; [device newTextureWithDescriptor:desc];</span><br><span class="line"></span><br><span class="line">int channels_per_pixel_ &#x3D; 4;</span><br><span class="line">int array_length_ &#x3D; desc_.arrayLength;</span><br><span class="line"></span><br><span class="line">auto count &#x3D; image_.width * image_.height * array_length_ * channels_per_pixel_;</span><br><span class="line">auto buffer &#x3D; static_cast&lt;uint16_t*&gt;(malloc(sizeof(uint16_t) * count));</span><br><span class="line"></span><br><span class="line">auto bytes_per_row &#x3D; image_.width * image_.depth * channels_per_pixel_ * sizeof(uint16_t);</span><br><span class="line">auto bytes_per_image &#x3D; image_.height * bytes_per_row;</span><br><span class="line">const MTLRegion region &#123;</span><br><span class="line">    .origin &#x3D; &#123;0, 0, 0&#125;,</span><br><span class="line">    .size &#x3D;&#123;</span><br><span class="line">        image_.width, image_.height, image_.depth,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; copy from cpu to gpu</span><br><span class="line">for (int i &#x3D; 0; i &lt; array_length_; ++i) &#123;</span><br><span class="line">    auto p &#x3D; buffer + image_.width * image_.height * channels_per_pixel_ * i;</span><br><span class="line">    [image_ replaceRegion:region</span><br><span class="line">              mipmapLevel:0</span><br><span class="line">                    slice:static_cast&lt;NSUInteger&gt;(i)</span><br><span class="line">                withBytes:p</span><br><span class="line">              bytesPerRow:bytes_per_row</span><br><span class="line">            bytesPerImage:bytes_per_image];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; copy from gpu to cpu</span><br><span class="line">auto* out_buffer &#x3D; static_cast&lt;uint16_t*&gt;(malloc(sizeof(uint16_t) * count));</span><br><span class="line">for (int i &#x3D; 0; i &lt; array_length_; ++i) &#123;</span><br><span class="line">    auto p &#x3D; out_buffer + image_.width * image_.height * channels_per_pixel_ * i;</span><br><span class="line"></span><br><span class="line">    [image_ getBytes:p</span><br><span class="line">         bytesPerRow:bytes_per_row</span><br><span class="line">       bytesPerImage:bytes_per_image</span><br><span class="line">          fromRegion:region</span><br><span class="line">         mipmapLevel:0</span><br><span class="line">               slice:static_cast&lt;NSUInteger&gt;(i)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>swift </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">let device &#x3D; MTLCreateSystemDefaultDevice()!</span><br><span class="line">let queue &#x3D; device.makeCommandQueue()!</span><br><span class="line">let textureDescriptor &#x3D; MTLTextureDescriptor()</span><br><span class="line">textureDescriptor.textureType &#x3D; .type2D</span><br><span class="line">textureDescriptor.pixelFormat &#x3D; .r16Uint</span><br><span class="line">textureDescriptor.width &#x3D; bufferWidth</span><br><span class="line">textureDescriptor.height &#x3D; 256</span><br><span class="line">textureDescriptor.usage &#x3D; [.shaderRead, .shaderWrite]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">let texture &#x3D; buffer?.makeTexture(descriptor: textureDescriptor, offset: 0, bytesPerRow: bufferWidth*MemoryLayout&lt;UInt16&gt;.stride)</span><br><span class="line"></span><br><span class="line">let texture &#x3D; device.makeTexture(descriptor: textureDescriptor)</span><br><span class="line">texture?.replace(region: MTLRegionMake2D(0, 0, w, h), mipmapLevel: 0, withBytes: data, bytesPerRow: 4 * w)</span><br><span class="line"></span><br><span class="line"># buffer</span><br><span class="line">let count &#x3D; 1500</span><br><span class="line">var myVector &#x3D; [Float](repeating: 0, count: count)</span><br><span class="line">var length &#x3D; count * MemoryLayout&lt; Float &gt;.stride</span><br><span class="line">var outBuffer &#x3D; device.makeBuffer(bytes: myVector, length: length, options: [])</span><br><span class="line">for (index, value) in myVector.enumerated() &#123; myVector[index] &#x3D; Float(index) &#125;</span><br><span class="line">var inBuffer &#x3D; device.makeBuffer(bytes: myVector, length: length, options: [])</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/content/2021/06/07/article/mnn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhangjun">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风花雪月">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/content/2021/06/07/article/mnn/" class="post-title-link" itemprop="url">MNN</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-06-07 12:27:48" itemprop="dateCreated datePublished" datetime="2021-06-07T12:27:48+00:00">2021-06-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-03 15:49:50" itemprop="dateModified" datetime="2023-10-03T15:49:50+00:00">2023-10-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文主要介绍Alibaba MNN编译使用。</p>
<h1 id="下载编译"><a href="#下载编译" class="headerlink" title="下载编译"></a>下载编译</h1><h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone github.com/alibaba/MNN</span><br></pre></td></tr></table></figure>
<h2 id="linux-x86"><a href="#linux-x86" class="headerlink" title="linux x86"></a>linux x86</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;schema&#x2F;generate.sh</span><br><span class="line">mkdir build &amp;&amp; cd build &amp;&amp; cmake .. &amp;&amp; make -j4</span><br></pre></td></tr></table></figure>
<p>refer to <code>https://www.yuque.com/mnn/en/build_linux</code></p>
<h1 id="模型部署示例"><a href="#模型部署示例" class="headerlink" title="模型部署示例"></a>模型部署示例</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> main();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/content/2021/04/14/article/cplusplus/gcc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhangjun">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风花雪月">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/content/2021/04/14/article/cplusplus/gcc/" class="post-title-link" itemprop="url">gcc</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-14 03:51:57" itemprop="dateCreated datePublished" datetime="2021-04-14T03:51:57+00:00">2021-04-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-03 15:49:50" itemprop="dateModified" datetime="2023-10-03T15:49:50+00:00">2023-10-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="content"><a href="#content" class="headerlink" title="content"></a>content</h1><h2 id="RVO-Return-Value-Optimization"><a href="#RVO-Return-Value-Optimization" class="headerlink" title="RVO(Return Value Optimization)"></a>RVO(Return Value Optimization)</h2><h2 id="NRVO-Named-Return-Value-Optimization"><a href="#NRVO-Named-Return-Value-Optimization" class="headerlink" title="NRVO(Named Return Value Optimization)"></a>NRVO(Named Return Value Optimization)</h2><h2 id="code-snipts"><a href="#code-snipts" class="headerlink" title="code snipts"></a>code snipts</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;algorithm&gt;</span><br><span class="line">#include &lt;cctype&gt;</span><br><span class="line"></span><br><span class="line">std::string lower(const std::string &amp;data) &#123;</span><br><span class="line">  std::string result &#x3D; data;</span><br><span class="line">  std::transform(result.begin(), result.end(), result.begin(),</span><br><span class="line">    [](unsigned char c)&#123; return std::tolower(c); &#125;);</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/content/2021/04/10/article/conv/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhangjun">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风花雪月">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/content/2021/04/10/article/conv/" class="post-title-link" itemprop="url">conv</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-10 11:04:13" itemprop="dateCreated datePublished" datetime="2021-04-10T11:04:13+00:00">2021-04-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-03 15:49:50" itemprop="dateModified" datetime="2023-10-03T15:49:50+00:00">2023-10-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>conv详细介绍。</p>
<h1 id="conv2d"><a href="#conv2d" class="headerlink" title="conv2d"></a>conv2d</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">inline bool IsExpand(const std::vector&lt;int64_t&gt;&amp; filter_dim,</span><br><span class="line">                     const std::vector&lt;int&gt;&amp; strides,</span><br><span class="line">                     const std::vector&lt;int&gt;&amp; paddings,</span><br><span class="line">                     const std::vector&lt;int&gt;&amp; dilations) &#123;</span><br><span class="line">  bool filter_1 &#x3D; true, strides_1 &#x3D; true, padding_0 &#x3D; true, dilation_1 &#x3D; true;</span><br><span class="line">  for (size_t j &#x3D; 0; j &lt; strides.size(); ++j) &#123;</span><br><span class="line">    filter_1 &#x3D; filter_1 &amp;&amp; (static_cast&lt;int&gt;(filter_dim[j + 2]) &#x3D;&#x3D; 1);</span><br><span class="line">    strides_1 &#x3D; strides_1 &amp;&amp; (strides[j] &#x3D;&#x3D; 1);</span><br><span class="line">    padding_0 &#x3D; padding_0 &amp;&amp; (paddings[j] &#x3D;&#x3D; 0);</span><br><span class="line">    dilation_1 &#x3D; dilation_1 &amp;&amp; (dilations[j] &#x3D;&#x3D; 1);</span><br><span class="line">  &#125;</span><br><span class="line">  return !(filter_1 &amp;&amp; strides_1 &amp;&amp; padding_0 &amp;&amp; dilation_1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; use col_shape in the im2col calculation</span><br><span class="line">&#x2F;&#x2F; col_shape_vec:</span><br><span class="line">&#x2F;&#x2F; &#123;i_c&#x2F;g, k_h, k_w, o_h, o_w&#125; or &#123;i_c&#x2F;g, k_d, k_h, k_w, o_d,o_h, o_w&#125;</span><br></pre></td></tr></table></figure>
<p>gemm calc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; use col_matrix_shape in the gemm calculation size:</span><br><span class="line">&#x2F;&#x2F; (i_c&#x2F;g * k_h * k_w, o_h * o_w) or (i_c&#x2F;g * k_d * k_h * k_w, o_d * o_h * o_w)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">static inline size_t naive_conv_out_size(size_t in_size, size_t pad,</span><br><span class="line">                                         size_t dilation, size_t ksize,</span><br><span class="line">                                         size_t stride) &#123;</span><br><span class="line">    return (in_size + 2 * pad - dilation * (ksize - 1) - 1) &#x2F; stride + 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static inline void naive_conv_fwd_nchw(const float *src, const float *filter,</span><br><span class="line">                                       float *dst, size_t n, size_t w, size_t h,</span><br><span class="line">                                       size_t c, size_t k, size_t fx, size_t fy,</span><br><span class="line">                                       size_t px, size_t py, size_t sx,</span><br><span class="line">                                       size_t sy, size_t dx, size_t dy, size_t group) &#123;</span><br><span class="line">    size_t oh &#x3D; naive_conv_out_size(h, py, dy, fy, sy);</span><br><span class="line">    size_t ow &#x3D; naive_conv_out_size(w, px, dx, fx, sx);</span><br><span class="line">    assert((group &gt;&#x3D; 1) &amp;&amp; (c % group &#x3D;&#x3D; 0) &amp;&amp; (k % group &#x3D;&#x3D; 0));</span><br><span class="line">    size_t k_per_group &#x3D; k &#x2F; group;</span><br><span class="line">    size_t c_per_group &#x3D; c &#x2F; group;</span><br><span class="line">        size_t ig, in, ik, ioh, iow, ic, is, ir;</span><br><span class="line">    size_t cur_h, cur_w, o_idx, i_idx, f_idx;</span><br><span class="line">    &#x2F;&#x2F; input:[n,c,h,w], filter:[k, c, fx, fy], output: [n, k, out_h, out_w]</span><br><span class="line">    for (ig &#x3D; 0; ig &lt; group; ig++) &#123;</span><br><span class="line">        for (in &#x3D; 0; in &lt; n; in++) &#123;</span><br><span class="line">            for (ik &#x3D; 0; ik &lt; k_per_group; ik++) &#123;</span><br><span class="line">                for (ioh &#x3D; 0; ioh &lt; oh; ioh++) &#123;</span><br><span class="line">                    for (iow &#x3D; 0; iow &lt; ow; iow++) &#123;</span><br><span class="line">                        &#x2F;&#x2F; sliding window for this filter</span><br><span class="line">                        float value &#x3D; .0f;</span><br><span class="line">                        o_idx &#x3D; in * k * oh * ow + ig * k_per_group * oh * ow + ik * oh * ow + ioh * ow + iow;</span><br><span class="line">                        for (ic &#x3D; 0; ic &lt; c_per_group; ic++) &#123;</span><br><span class="line">                            for (ir &#x3D; 0; ir &lt; fy; ir++) &#123;</span><br><span class="line">                                cur_h &#x3D; sy * ioh - py + dy * ir;</span><br><span class="line">                                if (cur_h &lt; 0 || cur_h &gt;&#x3D; h)</span><br><span class="line">                                    continue;</span><br><span class="line">                                for (is &#x3D; 0; is &lt; fx; is++) &#123;</span><br><span class="line">                                    cur_w &#x3D; sx * iow - px + dx * is;</span><br><span class="line">                                    if (cur_w &lt; 0 || cur_w &gt;&#x3D; w)</span><br><span class="line">                                        continue;</span><br><span class="line">                                    i_idx &#x3D; in * c * h * w + ig * c_per_group * h * w + ic * h * w +</span><br><span class="line">                                            cur_h * w + cur_w;</span><br><span class="line">                                    f_idx &#x3D; ig * k_per_group * c_per_group * fy * fx + ik * c_per_group * fy * fx + ic * fy * fx +</span><br><span class="line">                                            ir * fx + is;</span><br><span class="line">                                    value +&#x3D; src[i_idx] * filter[f_idx];</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        dst[o_idx] &#x3D; value;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; group &#x3D; 1</span><br><span class="line">static inline void naive_conv_fwd_nchw(const float *src, const float *filter,</span><br><span class="line">                                       float *dst, size_t n, size_t w, size_t h,</span><br><span class="line">                                       size_t c, size_t k, size_t fx, size_t fy,</span><br><span class="line">                                       size_t px, size_t py, size_t sx,</span><br><span class="line">                                       size_t sy, size_t dx, size_t dy, size_t group) &#123;</span><br><span class="line">    size_t oh &#x3D; naive_conv_out_size(h, py, dy, fy, sy);</span><br><span class="line">    size_t ow &#x3D; naive_conv_out_size(w, px, dx, fx, sx);</span><br><span class="line">    assert((group &gt;&#x3D; 1) &amp;&amp; (c % group &#x3D;&#x3D; 0) &amp;&amp; (k % group &#x3D;&#x3D; 0));</span><br><span class="line">    size_t k_per_group &#x3D; k &#x2F; group;</span><br><span class="line">    size_t c_per_group &#x3D; c &#x2F; group;</span><br><span class="line">        size_t ig, in, ik, ioh, iow, ic, is, ir;</span><br><span class="line">    size_t cur_h, cur_w, o_idx, i_idx, f_idx;</span><br><span class="line">    &#x2F;&#x2F; input:[n,c,h,w], filter:[k, c, fx, fy], output: [n, k, out_h, out_w]</span><br><span class="line">    for (ig &#x3D; 0; ig &lt; group; ig++) &#123;</span><br><span class="line">        for (in &#x3D; 0; in &lt; n; in++) &#123;</span><br><span class="line">            for (ik &#x3D; 0; ik &lt; k_per_group; ik++) &#123;</span><br><span class="line">                for (ioh &#x3D; 0; ioh &lt; oh; ioh++) &#123;</span><br><span class="line">                    for (iow &#x3D; 0; iow &lt; ow; iow++) &#123;</span><br><span class="line">                        &#x2F;&#x2F; sliding window for this filter</span><br><span class="line">                        float value &#x3D; .0f;</span><br><span class="line">                        o_idx &#x3D; in * k * oh * ow + ig * k_per_group * oh * ow + ik * oh * ow + ioh * ow + iow;</span><br><span class="line">                        for (ic &#x3D; 0; ic &lt; c_per_group; ic++) &#123;</span><br><span class="line">                            for (ir &#x3D; 0; ir &lt; fy; ir++) &#123;</span><br><span class="line">                                cur_h &#x3D; sy * ioh - py + dy * ir;</span><br><span class="line">                                if (cur_h &lt; 0 || cur_h &gt;&#x3D; h)</span><br><span class="line">                                    continue;</span><br><span class="line">                                for (is &#x3D; 0; is &lt; fx; is++) &#123;</span><br><span class="line">                                    cur_w &#x3D; sx * iow - px + dx * is;</span><br><span class="line">                                    if (cur_w &lt; 0 || cur_w &gt;&#x3D; w)</span><br><span class="line">                                        continue;</span><br><span class="line">                                    i_idx &#x3D; in * c * h * w + ig * c_per_group * h * w + ic * h * w +</span><br><span class="line">                                            cur_h * w + cur_w;</span><br><span class="line">                                    f_idx &#x3D; ig * k_per_group * c_per_group * fy * fx + ik * c_per_group * fy * fx + ic * fy * fx +</span><br><span class="line">                                            ir * fx + is;</span><br><span class="line">                                    value +&#x3D; src[i_idx] * filter[f_idx];</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        dst[o_idx] &#x3D; value;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; [bs, ic, ih, iw] &amp; pack_size&#x3D;8 &#x3D;&gt; [bs, ic&#x2F;8, ih, iw, 8]</span><br><span class="line">&#x2F;&#x2F; [bs, ic, ih, iw] &amp; pack_size&#x3D;4 &#x3D;&gt; [bs, ic&#x2F;4, ih, iw, 4]</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; filter [oc, ic, kh, kw] &amp; pack_in&#x3D;8, pack_out&#x3D;8 &#x3D;&gt; [oc&#x2F;8, ic&#x2F;8, kh, kw, 8, 8]</span><br><span class="line">&#x2F;&#x2F; filter [oc, ic, kh, kw] &amp; pack_in&#x3D;4, pack_out&#x3D;4 &#x3D;&gt; [ic&#x2F;4, ic&#x2F;4, kh, kw, 4, 4]</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; [bs, ]</span><br></pre></td></tr></table></figure>
<h1 id="conv3d"><a href="#conv3d" class="headerlink" title="conv3d"></a>conv3d</h1><h1 id="conv-depthwise"><a href="#conv-depthwise" class="headerlink" title="conv_depthwise"></a>conv_depthwise</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; [bs, ic, ih, iw] &amp; pack_size&#x3D;8 &#x3D;&gt; [bs, ic&#x2F;8, ih, iw, 8]</span><br><span class="line">&#x2F;&#x2F; [bs, ic, ih, iw] &amp; pack_size&#x3D;4 &#x3D;&gt; [bs, ic&#x2F;4, ih, iw, 4]</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; filter [oc, ic&#x2F;groups&#x3D;1, kh, kw]</span><br><span class="line">&#x2F;&#x2F; filter [oc, 1, ih, iw] &amp; pack_size&#x3D;8 &#x3D;&gt; [oc&#x2F;8, ih, iw, 8]</span><br><span class="line">&#x2F;&#x2F; filter [oc, 1, ih, iw] &amp; pack_size&#x3D;4 &#x3D;&gt; [ic&#x2F;4, ih, iw, 4]</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; output [bs, oc, oh, ow]</span><br><span class="line">&#x2F;&#x2F; output_trans [bs, oc&#x2F;8, oh, ow, 8]</span><br><span class="line">&#x2F;&#x2F; output_trans [bs, oc&#x2F;4, oh, ow, 4]</span><br><span class="line">&#x2F;&#x2F; [bs, oc&#x2F;8, oh, ow, 8] &#x3D;&gt; [bs, oc, oh, ow]</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/content/2021/04/05/article/std-async/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhangjun">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风花雪月">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/content/2021/04/05/article/std-async/" class="post-title-link" itemprop="url">std::async、std::future</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-05 14:22:20" itemprop="dateCreated datePublished" datetime="2021-04-05T14:22:20+00:00">2021-04-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-03 15:49:50" itemprop="dateModified" datetime="2023-10-03T15:49:50+00:00">2023-10-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="std-async-用法"><a href="#std-async-用法" class="headerlink" title="std::async 用法"></a>std::async 用法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">template&lt;class Fn, class... Args&gt;</span><br><span class="line">future&lt;typename result_of&lt;Fn(Args...)&gt;::type&gt; async(launch policy, Fn&amp;&amp; fn, Args&amp;&amp;...args);</span><br></pre></td></tr></table></figure>
<ul>
<li>std::launch::async<br>系统默认，调用时创建新线程, </li>
<li>std::launch::deferred<br>延迟到std::future调用wait()或者get()时才执行，主线程调用，不创建新线程</li>
</ul>
<p>std::async 封装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">template &lt;typename F, typename... Args&gt;</span><br><span class="line">auto really_async(F&amp;&amp; f, Args&amp;&amp;... args)</span><br><span class="line">-&gt; std::future&lt;typename std::result_of&lt;F(Args...)&gt;::type&gt;</span><br><span class="line">&#123;</span><br><span class="line">    using RetType &#x3D; typename std::result_of&lt;F(Args...)&gt;::type;</span><br><span class="line">    auto func &#x3D; std::bind(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...);</span><br><span class="line">    std::packaged_task&lt;RetType()&gt; task(std::move(func));</span><br><span class="line">    auto fut &#x3D; task.get_future();</span><br><span class="line">    std::thread trd(std::move(task));</span><br><span class="line">    trd.detach();</span><br><span class="line">    return fut;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="std-future-用法"><a href="#std-future-用法" class="headerlink" title="std::future 用法"></a>std::future 用法</h2><h3 id="std-future-status-三种状态"><a href="#std-future-status-三种状态" class="headerlink" title="std::future_status 三种状态"></a>std::future_status 三种状态</h3><ul>
<li>deferred<br>异步操作待开始</li>
<li>ready<br>异步操作完成</li>
<li>timeout<br>异步操作超时</li>
</ul>
<h2 id="std-promise"><a href="#std-promise" class="headerlink" title="std::promise"></a>std::promise</h2><h2 id="std-packaged-task"><a href="#std-packaged-task" class="headerlink" title="std::packaged_task"></a>std::packaged_task</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/content/2021/04/04/article/variadic-templates/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhangjun">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风花雪月">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/content/2021/04/04/article/variadic-templates/" class="post-title-link" itemprop="url">可变模版参数</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-04 14:06:42" itemprop="dateCreated datePublished" datetime="2021-04-04T14:06:42+00:00">2021-04-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-03 15:49:50" itemprop="dateModified" datetime="2023-10-03T15:49:50+00:00">2023-10-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="c-11-可变模版参数"><a href="#c-11-可变模版参数" class="headerlink" title="c++11 可变模版参数"></a>c++11 可变模版参数</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">template &lt;class... T&gt;</span><br><span class="line">void f(T... args);</span><br></pre></td></tr></table></figure>
<ul>
<li>递归函数展开参数包<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">template &lt;class... T&gt;</span><br><span class="line">void f(T... args)</span><br><span class="line">&#123;    </span><br><span class="line">  std::cout &lt;&lt; sizeof...(args) &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void func() &#123;&#125;</span><br><span class="line">template &lt;class T, class... Args&gt;</span><br><span class="line">void func(T first, Args... remain) &#123;</span><br><span class="line">  std::cout &lt;&lt; first &lt;&lt; &quot; &quot;;</span><br><span class="line">  if (sizeof...(remain) &#x3D;&#x3D; 0) return;</span><br><span class="line">  func(remain...);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">  func(2, 3, 9);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>逗号表达式展开参数包</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/content/2021/03/23/article/models/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhangjun">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风花雪月">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/content/2021/03/23/article/models/" class="post-title-link" itemprop="url">models</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-23 15:14:00" itemprop="dateCreated datePublished" datetime="2021-03-23T15:14:00+00:00">2021-03-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-03 15:49:50" itemprop="dateModified" datetime="2023-10-03T15:49:50+00:00">2023-10-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>介绍paddle、ncnn、tnn使用</p>
<h1 id="paddle"><a href="#paddle" class="headerlink" title="paddle"></a>paddle</h1><h2 id="x2paddle"><a href="#x2paddle" class="headerlink" title="x2paddle"></a>x2paddle</h2><p>x2paddle –framework=onnx –model=onnx_model.onnx –save_dir=mobilenet</p>
<h2 id="paddle2onnx"><a href="#paddle2onnx" class="headerlink" title="paddle2onnx"></a>paddle2onnx</h2><p>paddle2onnx –model_dir paddle_model  –save_file onnx_file –opset_version 10 –enable_onnx_checker True<br>paddle2onnx –model_dir paddle_model  –model_filename model_filename –params_filename params_filename –save_file onnx_file –opset_version 10 –enable_onnx_checker True</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">zhangjun</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">30</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhangjun</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  

</body>
</html>
